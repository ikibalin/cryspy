import os
import numpy

from cryspy.C_item_loop_classes.cl_1_refln import ReflnL
from cryspy.C_item_loop_classes.cl_1_refln_susceptibility import ReflnSusceptibilityL

from cryspy.D_functions_item_loop.structure_factor import \
    calc_b_iso_beta, \
    calculate_nuclear_structure_factor, \
    calculate_structure_factor_tensor

from cryspy.H_functions_global.function_1_cryspy_objects import \
    file_to_globaln

dir = os.path.dirname(__file__)
f_name = os.path.join(dir, "Ho2Ti2O7.rcif")
global_obj = file_to_globaln(f_name)
crystal = global_obj.crystal_Ho2Ti2O7

cell = crystal.cell
space_group = crystal.space_group
atom_site = crystal.atom_site
try:
    atom_site_aniso = crystal.atom_site_aniso
except:
    atom_site_aniso = None

atom_site_susceptibility = crystal.atom_site_susceptibility
atom_site_scat = crystal.atom_site_scat

diffrn = global_obj.diffrn_Ho2Ti2O7
diffrn_refln = diffrn.diffrn_refln

refln = ReflnL(
    index_h=diffrn_refln.index_h,
    index_k=diffrn_refln.index_k,
    index_l=diffrn_refln.index_l)

refln_susceptibility = ReflnSusceptibilityL(
    index_h=diffrn_refln.index_h,
    index_k=diffrn_refln.index_k,
    index_l=diffrn_refln.index_l)

b_iso = numpy.array([7.89568352, 0.78956835, 0., 0.], dtype=float)
beta = numpy.array(
    [[ 0., 0., 0., 0., 0., 0.],
     [ 0., 0., 0., 0., 0., 0.],
     [ 0.01897271, 0.00948636, 0.00948636, 0., 0.,-0.00569181],
     [ 0.01897271, 0.01897271, 0.01897271, 0., 0., 0.]], dtype=float).transpose()

f_nucl = numpy.array(
[  8.88649359-6.75658817e-15j,   3.58443199-2.91837944e-15j,
   3.58443199-4.39383368e-15j,  -2.55687861-2.35252310e-16j,
  -2.55687861+1.67463957e-15j,  16.82720283+0.00000000e+00j,
   6.62836015-8.05328026e-18j,  -6.61059606+1.65484628e-15j,
  -6.61059606+1.39714131e-15j,   6.61059606-3.67601399e-15j,
  -6.61059606-1.65484628e-15j,  -4.08080839-7.74906550e-16j,
  -4.08080839-6.72898333e-16j,  -4.08080839-9.46709862e-16j,
  -4.08080839-6.24578651e-16j, -11.65898627+5.14402933e-15j,
 -11.65898627+4.37091443e-15j,  11.65898627-3.80601891e-15j,
  -7.06440495+2.54734692e-15j,  -7.06440495+1.75573196e-15j,
  -7.06440495+2.97945760e-15j,  -1.29366877+1.44022715e-15j,
  -1.29366877+2.73837578e-15j,   1.29366877+6.42257739e-16j,
  -2.96907107+2.38963065e-15j,  -2.96907107+2.34956814e-15j,
  14.96082653-2.56256137e-15j,  14.96082653-2.56256137e-15j,
 -14.96082653+2.45910980e-15j, -14.96082653-2.12541705e-16j,
   6.43875787-1.32331634e-15j,  -6.43875787+7.23666819e-15j,
  -6.43875787+7.99172065e-15j,   6.43875787-2.35052709e-15j,
   0.45940682+4.80634174e-15j,   0.45940682+1.74645559e-15j,
  -2.00469575+1.61796195e-15j,  -2.00469575+4.91245987e-16j,
   2.37425067-1.65101679e-15j,   2.37425067+3.52509655e-16j,
  -3.29023941+6.33553542e-17j,  -3.29023941+4.06961979e-16j,
  -4.51885807-3.29422791e-16j,  -4.51885807+1.49645052e-15j,
   6.32611674-2.67193829e-15j,   6.32611674-1.47279968e-15j,
   6.32611674-2.72025798e-15j,   6.32611674-1.85935713e-15j,
  -0.52792364+2.29136358e-16j,  -0.52792364+7.44546295e-16j,
  -2.04599964+2.80997560e-16j,  -2.04599964+5.38702528e-16j,
   0.64125433-4.26965464e-16j,  -0.64125433+1.66886805e-15j,
  -0.64125433+1.24168385e-16j,   0.64125433-5.33505784e-17j,
  -0.04199748+3.92886189e-16j,  -0.04199748-2.03266068e-15j,
   0.0905004 -1.36284913e-15j,   0.0905004 +7.56132922e-16j,
   3.58155756-1.61079091e-15j,   3.58155756+1.34101208e-16j,
  -0.52435672+1.34963767e-15j,  -0.52435672+4.71099458e-16j,
  -0.52435672+1.09193270e-15j,  -0.52435672+7.93230669e-16j,
 -10.99996398+5.04248088e-15j, -10.99996398+4.06709036e-15j,
  -7.67364595+2.92330137e-15j,  -7.67364595+1.57845102e-15j,
   7.20629899+2.95704065e-16j,   7.20629899+5.10458206e-16j,
  -7.20629899+1.92899029e-15j,  -7.20629899-1.92758697e-15j,
   6.49162452-7.26697362e-16j,  -6.49162452+3.18922273e-15j,
  -6.49162452+2.38317361e-15j,   6.49162452-1.72853899e-15j,
   1.75695803-4.18405651e-15j,   1.75695803-4.56188957e-15j,
  -1.75695803+9.42278892e-16j,   0.29221635+6.19164530e-16j,
   0.29221635-9.65976939e-16j,   0.29221635+4.90312045e-16j,
   2.95231775+1.96430470e-16j,   2.95231775+9.97911063e-17j,
 -11.36515029+2.99213577e-15j, -11.36515029+2.82033246e-15j,
  -1.5845727 +1.72980085e-15j,  -1.5845727 +1.48547056e-15j,
  -1.5845727 +1.75127626e-15j,  -1.5845727 +7.33831067e-16j,
  -5.82031913+2.17719338e-15j,  -5.82031913+1.91948841e-15j], dtype=complex)

sft_ccs_11 = numpy.array(
[(1.9117834763977783-9.365038060133353e-16j), (-2.23785916704576e-16+6.034781404352118e-16j), -4.02318760290141e-16j, (-4.194792421931476e-17-3.7706655354318834e-16j), -2.639465874802319e-16j, (4.50355773725889+0j), (-9.573126543001168e-17+0j), (-5.071695274596276+3.1055176921425437e-16j), (-5.071695274596276+3.1055176921425427e-16j), (5.071695274596276-9.316553076427632e-16j), (-5.071695274596276-3.1055176921425437e-16j), (-4.036218845244272+1.1895516828646088e-15j), (-4.036218845244271+1.1895516828646084e-15j), (-4.036218845244272+1.1895516828646088e-15j), (-4.036218845244272+1.1895516828646084e-15j), (-2.582713701905335+1.6509444823991476e-15j), (-2.582713701905335+1.6509444823991476e-15j), (2.582713701905335-2.2539745110014035e-15j), (-1.3486944115796393+5.780860029591248e-16j), (-1.3486944115796393+2.786156851753263e-16j), (-1.3486944115796393-7.540981565429748e-16j), (-0.5823445932930208+4.502313741276561e-16j), (-0.5823445932930207+5.148846117016446e-16j), (0.5823445932930209-4.322117753455441e-18j), (-0.20985159596437705+3.0443419842734675e-16j), (-0.20985159596437705+9.475033219275846e-17j), (3.22362886116404-2.7116229471379474e-16j), (3.22362886116404-2.7116229471379474e-16j), (-3.2236288611640393+9.13179735225276e-16j), (-3.2236288611640393-5.183990585789193e-16j), (2.0749369453040116-3.811597332748715e-16j), (-2.074936945304011+1.5804655423712711e-15j), (-2.074936945304011+2.2715583737678415e-15j), (2.0749369453040116-3.8115973327487165e-16j), (1.0906186420133086+1.254677734047435e-16j), (1.0906186420133086-1.1669821208497604e-16j), (-0.47375508519323767+3.716978371254024e-16j), (-0.47375508519323767+2.6650307640244543e-16j), (-1.3486944115796389-6.660920797510501e-16j), (-1.3486944115796387+6.815243502760433e-16j), (-0.7167580754392199+1.3166632242744866e-16j), (-0.7167580754392199+1.3166632242744868e-16j), (-0.38587784737955755-1.9212843552595384e-17j), (-0.38587784737955755+1.9499239187419305e-16j), -9.344583705759928e-16j, (-3.465222831945535e-16+3.1148612352533135e-16j), (-3.465222831945535e-16-9.34458370575993e-16j), (-3.465222831945535e-16+3.1148612352533125e-16j), (3.2533954853735647-1.5564775678642826e-15j), (3.2533954853735647-1.5564775678642826e-15j), (0.6134999841096284-5.799969382981075e-16j), (0.6134999841096284-5.799969382981072e-16j), (-1.458389663030103e-16-5.243739462164556e-16j), -2.621869731082278e-16j, (-1.458389663030103e-16-2.6218697310822766e-16j), 3.9328045966234177e-16j, 7.538789461589648e-17j, (-2.795585784247239e-17-7.315143069671735e-34j), (1.396676610231431-4.811680601432595e-16j), (1.396676610231431+1.3908095211048031e-16j), -3.770665535431884e-16j, (-4.194792421931476e-17-1.1311996606295645e-16j), (-1.671054095590034+8.826613088052471e-16j), (-1.671054095590034-2.304843305856866e-16j), (-1.671054095590034+8.826613088052468e-16j), (-1.671054095590034-2.304843305856865e-16j), (-0.8834526094135797+5.748369792380772e-16j), (-0.8834526094135797+8.442226517001137e-17j), (-0.38587784737955755+2.5549487888021845e-16j), (-0.38587784737955755+1.2697173762414526e-16j), (1.0906186420133082-1.4361318621200873e-15j), (1.0906186420133082-1.4361318621200873e-15j), (-1.0906186420133082+9.268413508239623e-16j), (-1.0906186420133082-2.839885766246338e-16j), (0.5823445932930211-3.075980856922433e-16j), (-0.5823445932930211-1.3164776403823973e-16j), (-0.5823445932930211+1.2696518625771417e-16j), (0.5823445932930211-4.8985135396289425e-17j), (0.2568386166012016-5.151728992611849e-16j), (0.2568386166012016-5.151728992611851e-16j), (-0.25683861660120194+3.9523595216486095e-16j), (0.8333649147894905-5.007531617988699e-16j), (0.8333649147894905-1.3066479527324038e-16j), (0.8333649147894899-5.007531617988694e-16j), (-6.32125006336602e-17+5.113909252612165e-16j), 5.113909252612167e-16j, (-0.7167580754392199+3.7859613440014167e-16j), (-0.7167580754392199+3.785961344001416e-16j), (-0.38587784737955755+1.2255637764397846e-16j), (-0.38587784737955755+2.5107951890005157e-16j), (-0.38587784737955755+1.2255637764397846e-16j), (-0.38587784737955755+2.5107951890005147e-16j), (0.6134999841096284-2.935084183416101e-16j), (0.6134999841096284-2.935084183416101e-16j)],
dtype=complex)

sft_ccs_32 = numpy.array(
[(6.64368793615821e-32-1.180156050423557e-47j), (-1.370293532932576e-32-2.0287668043165582e-16j), (3.6547013695766712-2.1960406944999193e-15j), (-2.5685695563029782e-33+1.521142302774626e-16j), (0.6850615907953305-8.456321087560682e-16j), 0j, (9.573126543001168e-17+0j), (-5.114992404177088+3.1320295377192476e-16j), (5.114992404177087-3.132029537719247e-16j), (-5.114992404177088+9.396088613157743e-16j), (-5.114992404177088-3.1320295377192476e-16j), (-4.0706760988640625+2.95835235150907e-16j), (4.0706760988640625-1.1997069013009453e-15j), (-4.070676098864063+1.199706901300946e-15j), (-4.0706760988640625+2.9583523515090713e-16j), (-2.6047623629086205+1.665038617262338e-15j), (2.6047623629086196-5.082917576710668e-16j), (-2.6047623629086196-4.027699799483278e-17j), (1.36020823359406-5.830211308056942e-16j), (-1.3602082335940604+8.850480306498621e-16j), (-1.3602082335940602+1.0516254965943462e-15j), (-0.5873160767815475+1.9325427284815834e-16j), (0.5873160767815473-2.584594559656973e-16j), (-0.5873160767815473-2.5646171674032346e-16j), (0.21164310181227777-2.1304473934833598e-16j), (-0.21164310181227786+1.8954763488482835e-16j), (-3.2511490233515006+1.7172774116921002e-15j), (-3.2511490233515006+1.7172774116920998e-15j), (3.2511490233515-9.20975562692408e-16j), (-3.2511490233515006-5.228246381925624e-16j), (-2.092650709426008+3.844136989547998e-16j), (-2.0926507094260076+2.0586197976126603e-15j), (-2.0926507094260076+2.290950697622952e-15j), (-2.092650709426008+3.844136989547997e-16j), (-1.0999292677725145+1.3388612648038267e-15j), (-1.0999292677725145+1.5830946245118535e-15j), (-0.4777995386161245+5.870566460436244e-16j), (-0.4777995386161245+2.6877821668748567e-16j), (-1.36020823359406-3.697516167940094e-16j), (1.3602082335940597-6.873425326605774e-16j), (-0.7228770486010796+1.327903595619596e-16j), (-0.7228770486010796+4.538122568939585e-16j), (0.3891720916619464+1.922039905337483e-16j), (-0.3891720916619465+2.3829917818564195e-17j), (5.659138348066002-4.4365327874390676e-16j), (3.465222831945535e-16-3.1414528467810254e-16j), (3.465222831945535e-16+3.141452846781023e-16j), (-2.121837024737213e-32+3.141452846781027e-16j), (-5.314950348926567e-32+3.6428302215010945e-16j), (-5.314950348926567e-32-3.6428302215010954e-16j), (1.3287375872316418e-32-2.0608096615235639e-16j), (1.3287375872316418e-32-6.869365538411879e-17j), (-8.930061163697011e-33+5.288505335248174e-16j), (2.381731065717055-9.022864636616738e-16j), (-8.930061163697011e-33+2.6442526676240845e-16j), (2.381731065717055-4.511432318308369e-16j), (0.45655380574932053-2.0875115732888441e-16j), (-1.7118025912101124e-33+2.0275061884925473e-16j), (1.3287375872316418e-32+3.1277204313391736e-16j), (1.3287375872316418e-32+3.127720431339172e-16j), (0.6850615907953305-9.173458173852778e-17j), (-2.5685695563029782e-33+3.4225701812429087e-16j), (-1.6853199064867792+1.417642144464401e-16j), (1.685319906486779-5.159804072545875e-16j), (-1.6853199064867792+1.4176421444644012e-16j), (-1.6853199064867792-2.3245197836170757e-16j), (-0.8909946560148185+1.8406325735595598e-16j), (0.8909946560148182-4.808240919336427e-16j), (0.3891720916619464-2.576760420375399e-16j), (-0.3891720916619465+2.144692603670774e-16j), (-1.099929267772514+9.599254193891892e-16j), (-1.099929267772514-5.054747388589717e-16j), (1.0999292677725143-4.46287088267942e-16j), (-1.0999292677725145+4.46287088267942e-16j), (-0.5873160767815477+5.710447870848102e-16j), (-0.5873160767815477+5.192801884358536e-16j), (-0.5873160767815477+5.192801884358539e-16j), (-0.5873160767815477+3.1022405461465397e-16j), (-0.25903125126520443+1.7447198600758639e-16j), (-0.25903125126520443+5.943900230674878e-17j), (-0.25903125126520465+1.6854411930979219e-16j), (-6.643687936158209e-33+9.33119539503283e-17j), (-6.643687936158209e-33-9.33119539503283e-17j), -9.331195395032821e-17j, (-3.8706493283556006e-33-4.0114408160408964e-16j), (1.0323384779623184-1.0455592346519207e-16j), (-0.7228770486010797+7.028501119345977e-16j), (0.7228770486010795-3.818282146025988e-16j), (-0.38917209166194644+2.9642976974133656e-16j), (0.3891720916619464-8.039586138902403e-17j), (-0.3891720916619465+3.828433330822616e-16j), (-0.38917209166194644+2.53222988070874e-16j), (1.3287375872316418e-32+6.869365538411873e-17j), (1.3287375872316418e-32+6.869365538411879e-17j)],
dtype=complex)

def test_calc_b_iso_beta():
    res_1, res_2 = calc_b_iso_beta(atom_site, atom_site_aniso, cell)

    print("res_1: ", res_1)
    print(b_iso)
    print("res_2: ", res_2)
    print(beta)

    assert numpy.all(numpy.isclose(res_1, b_iso))
    assert numpy.all(numpy.isclose(res_2, beta))


def test_calculate_nuclear_structure_factor():
    calculate_nuclear_structure_factor(
        refln, space_group, cell, atom_site, atom_site_aniso)
    
    print("refln.numpy_f_calc: ", refln.numpy_f_calc)
    print(f_nucl)

    assert numpy.all(numpy.isclose(refln.numpy_f_calc, f_nucl))

def test_calculate_structure_factor_tensor():
    calculate_structure_factor_tensor(
        refln_susceptibility, space_group, cell,
        atom_site, atom_site_susceptibility,
        atom_site_scat,
        atom_site_aniso=atom_site_aniso, flag_only_orbital=False)
    
    print("refln_susceptibility.chi_11: ", refln_susceptibility.chi_11_calc)
    print("refln_susceptibility.chi_11: ", refln_susceptibility.chi_32_calc)
    
    assert numpy.all(numpy.isclose(refln_susceptibility.chi_11_calc, sft_ccs_11))

    assert numpy.all(numpy.isclose(refln_susceptibility.chi_32_calc, sft_ccs_32))

